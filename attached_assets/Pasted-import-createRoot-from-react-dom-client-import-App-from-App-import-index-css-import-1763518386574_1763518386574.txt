import { createRoot } from "react-dom/client";
import App from "./App";
import "./index.css";
import "./lib/i18n";

import '@ionic/react/css/core.css';
import '@ionic/react/css/normalize.css';
import '@ionic/react/css/structure.css';
import '@ionic/react/css/typography.css';
import '@ionic/react/css/padding.css';
import '@ionic/react/css/float-elements.css';
import '@ionic/react/css/text-alignment.css';
import '@ionic/react/css/text-transformation.css';
import '@ionic/react/css/flex-utils.css';
import '@ionic/react/css/display.css';

import { PushNotifications } from '@capacitor/push-notifications';
import { LocalNotifications } from '@capacitor/local-notifications';
import { Haptics, ImpactStyle, NotificationType } from '@capacitor/haptics';
import { Badge } from '@capawesome/capacitor-badge';
import { Capacitor } from '@capacitor/core';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JAKA VIBRACIJA - ERROR tip notifikacije + Heavy Impact
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function vibrateStrong() {
  if (Capacitor.isNativePlatform()) {
    try {
      await Haptics.notification({ type: NotificationType.Error });
      await Haptics.impact({ style: ImpactStyle.Heavy });
    } catch (error) {
      console.error('Gre≈°ka pri vibraciji:', error);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOKALNA POPUP NOTIFIKACIJA SA CUSTOM ZVUKOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function showLocal(title: string, body: string) {
  if (Capacitor.isNativePlatform()) {
    try {
      const isAndroid = Capacitor.getPlatform() === 'android';
      await LocalNotifications.schedule({
        notifications: [
          {
            id: Date.now(),
            title,
            body,
            sound: isAndroid ? "alert1" : "alert1.mp3", // Android bez ekstenzije, iOS sa ekstenzijom
            channelId: isAndroid ? 'reklamacije-alert' : undefined,
            smallIcon: "ic_launcher"
          }
        ]
      });
    } catch (error) {
      console.error('Gre≈°ka pri prikazivanju notifikacije:', error);
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// KREIRANJE ANDROID NOTIFICATION KANALA SA CUSTOM ZVUKOM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function createNotificationChannel() {
  if (Capacitor.getPlatform() === 'android') {
    try {
      await LocalNotifications.createChannel({
        id: 'reklamacije-alert',
        name: 'Reklamacije Alerte',
        description: 'Jaki alarmi za nove reklamacije',
        importance: 5, // IMPORTANCE_HIGH
        sound: 'alert1', // Bez ekstenzije za Android resurse
        vibration: true,
        visibility: 1, // PUBLIC
      });
      console.log('Notification kanal kreiran uspe≈°no');
    } catch (error) {
      console.error('Gre≈°ka pri kreiranju notification kanala:', error);
    }
  }
}

// Globalna varijabla za praƒáenje badge permisija
let badgePermissionsGranted = false;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INICIJALIZACIJA PUSH NOTIFIKACIJA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initializePushNotifications() {
  console.log('üîî [PUSH INIT] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  console.log('üîî [PUSH INIT] Poƒçetak inicijalizacije push notifikacija...');
  console.log('üîî [PUSH INIT] ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
  
  if (!Capacitor.isNativePlatform()) {
    console.log('‚ùå [PUSH INIT] Push notifikacije su dostupne samo na mobilnim ureƒëajima');
    return;
  }

  try {
    console.log('üîî [PUSH INIT] Zahtevam permisije za lokalne notifikacije...');
    // 1. Zahtevaj permisije za lokalne notifikacije
    await LocalNotifications.requestPermissions();
    
    // 2. Kreiraj Android notification kanal sa custom zvukom (Android 8+)
    await createNotificationChannel();

    // 3. Zahtevaj badge permisije (KRITIƒåNO za iOS)
    try {
      const badgePerms = await Badge.requestPermissions();
      badgePermissionsGranted = badgePerms.display === 'granted';
      console.log('Badge permisije:', badgePermissionsGranted ? 'odobrene' : 'nisu odobrene');
    } catch (error) {
      console.error('Gre≈°ka pri zahtevanju badge permisija:', error);
    }

    // 4. Zahtevaj push notifikacije permisije
    const permResult = await PushNotifications.requestPermissions();
    
    if (permResult.receive === 'granted') {
      // Registruj za push notifikacije
      await PushNotifications.register();
      console.log('Push notifikacije uspe≈°no registrovane');
    } else {
      console.warn('Push notifikacije nisu odobrene');
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // LISTENER: Nova push notifikacija primljena (FOREGROUND ONLY)
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // HYBRID STRATEGY:
    // - Backend ≈°alje notification block (za background/terminated delivery) + data block
    // - Ovaj listener se poziva SAMO kada je app u foreground-u
    // - Na nekim ureƒëajima (Samsung, Xiaomi), sistem automatski prikazuje notifikaciju
    //   i u foreground-u, ≈°to bi kreiralo duplikat ako mi kreiramo lokalnu notifikaciju
    // - Zato proveravamo da li je notifikacija veƒá prikazana pre nego ≈°to kreiramo lokalnu
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    PushNotifications.addListener('pushNotificationReceived', async (notification) => {
      console.log('Nova push notifikacija primljena (foreground):', notification);
      
      // UVEK: Jaka vibracija i badge poveƒáanje (ovo ne kreira duplikat)
      await vibrateStrong();
      
      if (badgePermissionsGranted) {
        try {
          await Badge.increase();
        } catch (error) {
          console.error('Gre≈°ka pri poveƒáanju badge-a:', error);
        }
      }
      
      // OPCIONO: Kreiraj lokalnu notifikaciju SAMO ako backend zahteva
      // Ovo omoguƒáava backend-u da kontroli≈°e da li treba dodatna notifikacija
      // Na veƒáini Android ureƒëaja, notifikacija se NE prikazuje u foreground-u automatski,
      // pa moramo kreirati lokalnu. Backend mo≈æe poslati forceLocal: "true" u data block-u.
      const shouldShowLocal = notification.data?.forceLocal !== 'false';
      
      if (shouldShowLocal) {
        await showLocal(
          notification.title || notification.data?.title || 'Nova reklamacija',
          notification.body || notification.data?.body || 'Kliknite da vidite detalje'
        );
      }
    });

    // Listener za kada korisnik klikne na notifikaciju
    PushNotifications.addListener('pushNotificationActionPerformed', async (notification) => {
      console.log('Notifikacija kliknuta:', notification);
      
      // Oƒçisti badge kada korisnik otvori app preko notifikacije
      if (badgePermissionsGranted) {
        try {
          await Badge.clear();
        } catch (error) {
          console.error('Gre≈°ka pri ƒçi≈°ƒáenju badge-a:', error);
        }
      }
    });

    // Listener za uspe≈°nu registraciju
    PushNotifications.addListener('registration', async (token) => {
      console.log('‚úÖ Push registration token primljen:', token.value);
      
      // Saƒçuvaj token ODMAH u localStorage (biƒáe poslat nakon login-a ako korisnik nije ulogovan)
      localStorage.setItem('pending_push_token', token.value);
      
      // Poku≈°aj da po≈°alje≈° token na backend ako je korisnik veƒá ulogovan
      try {
        const authToken = localStorage.getItem('authToken');
        if (!authToken) {
          console.warn('‚ö†Ô∏è Korisnik nije ulogovan - push token ƒáe biti poslat nakon login-a');
          return;
        }

        const response = await fetch('/api/users/push-token', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${authToken}`
          },
          body: JSON.stringify({ token: token.value })
        });

        if (response.ok) {
          console.log('‚úÖ Push token uspe≈°no poslat na server');
          // Obri≈°i pending token jer je uspe≈°no poslat
          localStorage.removeItem('pending_push_token');
        } else {
          console.error('‚ùå Gre≈°ka pri slanju push tokena na server:', await response.text());
        }
      } catch (error) {
        console.error('‚ùå Gre≈°ka pri slanju push tokena:', error);
      }
    });

    // Listener za gre≈°ke pri registraciji
    PushNotifications.addListener('registrationError', (error) => {
      console.error('Gre≈°ka pri registraciji push notifikacija:', error);
    });

  } catch (error) {
    console.error('Gre≈°ka pri inicijalizaciji push notifikacija:', error);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MANUAL PUSH TOKEN RETRY (za debugging)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
export async function sendPendingPushToken() {
  const pendingToken = localStorage.getItem('pending_push_token');
  const authToken = localStorage.getItem('authToken');
  
  if (!pendingToken) {
    console.warn('‚ö†Ô∏è Nema pending push tokena');
    return false;
  }
  
  if (!authToken) {
    console.warn('‚ö†Ô∏è Korisnik nije ulogovan');
    return false;
  }
  
  try {
    const response = await fetch('/api/users/push-token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${authToken}`
      },
      body: JSON.stringify({ token: pendingToken })
    });
    
    if (response.ok) {
      console.log('‚úÖ Pending push token uspe≈°no poslat!');
      localStorage.removeItem('pending_push_token');
      return true;
    } else {
      console.error('‚ùå Gre≈°ka pri slanju:', await response.text());
      return false;
    }
  } catch (error) {
    console.error('‚ùå Gre≈°ka:', error);
    return false;
  }
}

// Export za globalnu upotrebu (mo≈æe se pozvati iz browser console)
if (typeof window !== 'undefined') {
  (window as any).sendPendingPushToken = sendPendingPushToken;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// POKRETANJE INICIJALIZACIJE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
console.log('üöÄ [MAIN] Aplikacija se pokreƒáe...');
console.log('üì± [MAIN] Capacitor.isNativePlatform():', Capacitor.isNativePlatform());
console.log('üåê [MAIN] Platform:', Capacitor.getPlatform());

if (Capacitor.isNativePlatform()) {
  console.log('‚úÖ [MAIN] Detektovana MOBILNA platforma - pokreƒáem push notifications...');
  initializePushNotifications()
    .then(() => console.log('‚úÖ [MAIN] Push notifications inicijalizovane'))
    .catch(error => console.error('‚ùå [MAIN] Gre≈°ka pri inicijalizaciji:', error));
} else {
  console.warn('‚ö†Ô∏è [MAIN] WEB platforma - push notifications NEƒÜE raditi!');
}

createRoot(document.getElementById("root")!).render(<App />);
